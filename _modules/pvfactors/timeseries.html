

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pvfactors.timeseries &mdash; pvfactors 0.1.5+24.g5ce1047 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> pvfactors
          

          
            
            <img src="../../_static/sp_2014_logo_all_white_LARGE.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.1.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/index.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../theory/index.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whatsnew.html">Whatâ€™s New</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pvfactors</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pvfactors.timeseries</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pvfactors.timeseries</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;All the functions necessary for timeseries calculations.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">pvlib</span> <span class="k">import</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">irradiance</span>
<span class="kn">from</span> <span class="nn">pvlib.tools</span> <span class="k">import</span> <span class="n">cosd</span><span class="p">,</span> <span class="n">sind</span>
<span class="kn">from</span> <span class="nn">pvlib.irradiance</span> <span class="k">import</span> <span class="n">aoi_projection</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pvfactors</span> <span class="k">import</span> <span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">print_progress</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pvfactors.pvarray</span> <span class="k">import</span> <span class="n">Array</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">cpu_count</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>


<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>


<span class="n">COLS_TO_SAVE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;q0&#39;</span><span class="p">,</span> <span class="s1">&#39;qinc&#39;</span><span class="p">,</span> <span class="s1">&#39;circumsolar_term&#39;</span><span class="p">,</span> <span class="s1">&#39;horizon_term&#39;</span><span class="p">,</span>
                <span class="s1">&#39;direct_term&#39;</span><span class="p">,</span> <span class="s1">&#39;irradiance_term&#39;</span><span class="p">,</span> <span class="s1">&#39;isotropic_term&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reflection_term&#39;</span><span class="p">,</span> <span class="s1">&#39;horizon_band_shading_pct&#39;</span><span class="p">]</span>
<span class="n">DISTANCE_TOLERANCE</span> <span class="o">=</span> <span class="mf">1e-8</span>
<span class="n">idx_slice</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span>


<div class="viewcode-block" id="array_timeseries_calculate"><a class="viewcode-back" href="../../developer/generated/pvfactors.timeseries.array_timeseries_calculate.html#pvfactors.timeseries.array_timeseries_calculate">[docs]</a><span class="k">def</span> <span class="nf">array_timeseries_calculate</span><span class="p">(</span>
    <span class="n">pvarray_parameters</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">solar_zenith</span><span class="p">,</span> <span class="n">solar_azimuth</span><span class="p">,</span> <span class="n">surface_tilt</span><span class="p">,</span>
        <span class="n">surface_azimuth</span><span class="p">,</span> <span class="n">dni</span><span class="p">,</span> <span class="n">luminance_isotropic</span><span class="p">,</span> <span class="n">luminance_circumsolar</span><span class="p">,</span>
        <span class="n">poa_horizon</span><span class="p">,</span> <span class="n">poa_circumsolar</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the view factor radiosity and irradiance terms for multiple</span>
<span class="sd">    times.</span>
<span class="sd">    The function inputs assume a diffuse sky dome as represented in the Perez</span>
<span class="sd">    diffuse sky transposition model (from ``pvlib-python`` implementation).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pvarray_parameters : dict</span>
<span class="sd">        parameters used to instantiate :py:class:`~pvfactors.pvarray.Array`</span>
<span class="sd">    timestamps : array-like</span>
<span class="sd">        simulation timestamps</span>
<span class="sd">    solar_zenith : array-like</span>
<span class="sd">        solar zenith angles</span>
<span class="sd">    solar_azimuth : array-like</span>
<span class="sd">        solar azimuth angles</span>
<span class="sd">    surface_tilt : array-like</span>
<span class="sd">        Surface tilt angles in decimal degrees.</span>
<span class="sd">        surface_tilt must be &gt;=0 and &lt;=180.</span>
<span class="sd">        The tilt angle is defined as degrees from horizontal</span>
<span class="sd">        (e.g. surface facing up = 0, surface facing horizon = 90)</span>
<span class="sd">    surface_azimuth : array-like</span>
<span class="sd">        The azimuth of the rotated panel,</span>
<span class="sd">        determined by projecting the vector normal to the panel&#39;s surface to</span>
<span class="sd">        the earth&#39;s surface [degrees].</span>
<span class="sd">    dni : array-like</span>
<span class="sd">        values for direct normal irradiance</span>
<span class="sd">    luminance_isotropic : array-like</span>
<span class="sd">        luminance of the isotropic sky dome</span>
<span class="sd">    luminance_circumsolar : array-like</span>
<span class="sd">        luminance of circumsolar area</span>
<span class="sd">    poa_horizon : array-like</span>
<span class="sd">        POA irradiance horizon component</span>
<span class="sd">    poa_circumsolar : array-like</span>
<span class="sd">        POA irradiance circumsolar component</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df_registries : `pandas.DataFrame`</span>
<span class="sd">        Timeseries concatenated form of the</span>
<span class="sd">        :py:class:`~pvfactors.pvarray.Array` surface registry</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Instantiate array</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="o">**</span><span class="n">pvarray_parameters</span><span class="p">)</span>
    <span class="c1"># We want to save the whole registry for each timestamp</span>
    <span class="n">list_registries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># We want to record the skipped_ts</span>
    <span class="n">skipped_ts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Use for printing progress</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timestamps</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">solar_zenith</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="nb">float</span><span class="p">))</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">solar_zenith</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">90.</span><span class="p">)):</span>
                <span class="c1"># Run calculation only if daytime</span>
                <span class="n">array</span><span class="o">.</span><span class="n">calculate_radiosities_perez</span><span class="p">(</span>
                    <span class="n">solar_zenith</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">solar_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">surface_tilt</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                    <span class="n">surface_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">dni</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">luminance_isotropic</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                    <span class="n">luminance_circumsolar</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">poa_horizon</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                    <span class="n">poa_circumsolar</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

                <span class="c1"># Save the whole registry</span>
                <span class="n">registry</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">surface_registry</span><span class="p">)</span>
                <span class="n">registry</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span>
                <span class="n">list_registries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">skipped_ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unexpected error: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="n">skipped_ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>

        <span class="c1"># Printing progress</span>
        <span class="n">print_progress</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;Progress:&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;Complete&#39;</span><span class="p">,</span>
                       <span class="n">bar_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Concatenate all surface registries into one dataframe</span>
    <span class="k">if</span> <span class="n">list_registries</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">skipped_ts</span><span class="p">:</span>
            <span class="n">df_skipped</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">Array</span><span class="o">.</span><span class="n">registry_cols</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">skipped_ts</span><span class="p">))</span>
            <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">timestamps</span><span class="o">=</span><span class="n">skipped_ts</span><span class="p">)</span>
            <span class="n">list_registries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_skipped</span><span class="p">)</span>
        <span class="n">df_registries</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">list_registries</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span>
                                   <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">])</span>
                         <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_registries</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">Array</span><span class="o">.</span><span class="n">registry_cols</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">))</span>
        <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">timestamps</span><span class="o">=</span><span class="n">timestamps</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_registries</span></div>


<div class="viewcode-block" id="perez_diffuse_luminance"><a class="viewcode-back" href="../../developer/generated/pvfactors.timeseries.perez_diffuse_luminance.html#pvfactors.timeseries.perez_diffuse_luminance">[docs]</a><span class="k">def</span> <span class="nf">perez_diffuse_luminance</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">surface_tilt</span><span class="p">,</span> <span class="n">surface_azimuth</span><span class="p">,</span>
                            <span class="n">solar_zenith</span><span class="p">,</span> <span class="n">solar_azimuth</span><span class="p">,</span> <span class="n">dni</span><span class="p">,</span> <span class="n">dhi</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function used to calculate the luminance and the view factor terms from the</span>
<span class="sd">    Perez diffuse light transposition model, as implemented in the</span>
<span class="sd">    ``pvlib-python`` library.</span>
<span class="sd">    This function was custom made to allow the calculation of the circumsolar</span>
<span class="sd">    component on the back surface as well. Otherwise, the ``pvlib``</span>
<span class="sd">    implementation would ignore it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    timestamps : array-like</span>
<span class="sd">        simulation timestamps</span>
<span class="sd">    surface_tilt : array-like</span>
<span class="sd">        Surface tilt angles in decimal degrees.</span>
<span class="sd">        surface_tilt must be &gt;=0 and &lt;=180.</span>
<span class="sd">        The tilt angle is defined as degrees from horizontal</span>
<span class="sd">        (e.g. surface facing up = 0, surface facing horizon = 90)</span>
<span class="sd">    surface_azimuth : array-like</span>
<span class="sd">        The azimuth of the rotated panel,</span>
<span class="sd">        determined by projecting the vector normal to the panel&#39;s surface to</span>
<span class="sd">        the earth&#39;s surface [degrees].</span>
<span class="sd">    solar_zenith : array-like</span>
<span class="sd">        solar zenith angles</span>
<span class="sd">    solar_azimuth : array-like</span>
<span class="sd">        solar azimuth angles</span>
<span class="sd">    dni : array-like</span>
<span class="sd">        values for direct normal irradiance</span>
<span class="sd">    dhi : array-like</span>
<span class="sd">        values for diffuse horizontal irradiance</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df_inputs : `pandas.DataFrame`</span>
<span class="sd">        Dataframe with the following columns:</span>
<span class="sd">        [&#39;solar_zenith&#39;, &#39;solar_azimuth&#39;, &#39;surface_tilt&#39;, &#39;surface_azimuth&#39;,</span>
<span class="sd">        &#39;dhi&#39;, &#39;dni&#39;, &#39;vf_horizon&#39;, &#39;vf_circumsolar&#39;, &#39;vf_isotropic&#39;,</span>
<span class="sd">        &#39;luminance_horizon&#39;, &#39;luminance_circumsolar&#39;, &#39;luminance_isotropic&#39;,</span>
<span class="sd">        &#39;poa_isotropic&#39;, &#39;poa_circumsolar&#39;, &#39;poa_horizon&#39;, &#39;poa_total_diffuse&#39;]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a dataframe to help filtering on all arrays</span>
    <span class="n">df_inputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;surface_tilt&#39;</span><span class="p">:</span> <span class="n">surface_tilt</span><span class="p">,</span> <span class="s1">&#39;surface_azimuth&#39;</span><span class="p">:</span> <span class="n">surface_azimuth</span><span class="p">,</span>
         <span class="s1">&#39;solar_zenith&#39;</span><span class="p">:</span> <span class="n">solar_zenith</span><span class="p">,</span> <span class="s1">&#39;solar_azimuth&#39;</span><span class="p">:</span> <span class="n">solar_azimuth</span><span class="p">,</span>
         <span class="s1">&#39;dni&#39;</span><span class="p">:</span> <span class="n">dni</span><span class="p">,</span> <span class="s1">&#39;dhi&#39;</span><span class="p">:</span> <span class="n">dhi</span><span class="p">},</span>
        <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">timestamps</span><span class="p">))</span>

    <span class="n">dni_et</span> <span class="o">=</span> <span class="n">irradiance</span><span class="o">.</span><span class="n">extraradiation</span><span class="p">(</span><span class="n">df_inputs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">)</span>
    <span class="n">am</span> <span class="o">=</span> <span class="n">atmosphere</span><span class="o">.</span><span class="n">relativeairmass</span><span class="p">(</span><span class="n">df_inputs</span><span class="o">.</span><span class="n">solar_zenith</span><span class="p">)</span>

    <span class="c1"># Need to treat the case when the sun is hitting the back surface of pvrow</span>
    <span class="n">aoi_proj</span> <span class="o">=</span> <span class="n">aoi_projection</span><span class="p">(</span>
        <span class="n">df_inputs</span><span class="o">.</span><span class="n">surface_tilt</span><span class="p">,</span> <span class="n">df_inputs</span><span class="o">.</span><span class="n">surface_azimuth</span><span class="p">,</span>
        <span class="n">df_inputs</span><span class="o">.</span><span class="n">solar_zenith</span><span class="p">,</span> <span class="n">df_inputs</span><span class="o">.</span><span class="n">solar_azimuth</span><span class="p">)</span>
    <span class="n">sun_hitting_back_surface</span> <span class="o">=</span> <span class="p">((</span><span class="n">aoi_proj</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                                <span class="p">(</span><span class="n">df_inputs</span><span class="o">.</span><span class="n">solar_zenith</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">))</span>
    <span class="n">df_inputs_back_surface</span> <span class="o">=</span> <span class="n">df_inputs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sun_hitting_back_surface</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Reverse the surface normal to switch to back-surface circumsolar calc</span>
    <span class="n">df_inputs_back_surface</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;surface_azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_inputs_back_surface</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;surface_azimuth&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">180.</span><span class="p">)</span>
    <span class="n">df_inputs_back_surface</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;surface_azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span>
        <span class="n">df_inputs_back_surface</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;surface_azimuth&#39;</span><span class="p">],</span> <span class="mf">360.</span>
    <span class="p">)</span>
    <span class="n">df_inputs_back_surface</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;surface_tilt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">180.</span> <span class="o">-</span> <span class="n">df_inputs_back_surface</span><span class="o">.</span><span class="n">surface_tilt</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_inputs_back_surface</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Use recursion to calculate circumsolar luminance for back surface</span>
        <span class="n">df_inputs_back_surface</span> <span class="o">=</span> <span class="n">perez_diffuse_luminance</span><span class="p">(</span>
            <span class="o">*</span><span class="n">breakup_df_inputs</span><span class="p">(</span><span class="n">df_inputs_back_surface</span><span class="p">))</span>

    <span class="c1"># Calculate Perez diffuse components</span>
    <span class="n">components</span> <span class="o">=</span> <span class="n">irradiance</span><span class="o">.</span><span class="n">perez</span><span class="p">(</span><span class="n">df_inputs</span><span class="o">.</span><span class="n">surface_tilt</span><span class="p">,</span>
                                  <span class="n">df_inputs</span><span class="o">.</span><span class="n">surface_azimuth</span><span class="p">,</span>
                                  <span class="n">df_inputs</span><span class="o">.</span><span class="n">dhi</span><span class="p">,</span> <span class="n">df_inputs</span><span class="o">.</span><span class="n">dni</span><span class="p">,</span>
                                  <span class="n">dni_et</span><span class="p">,</span>
                                  <span class="n">df_inputs</span><span class="o">.</span><span class="n">solar_zenith</span><span class="p">,</span>
                                  <span class="n">df_inputs</span><span class="o">.</span><span class="n">solar_azimuth</span><span class="p">,</span>
                                  <span class="n">am</span><span class="p">,</span>
                                  <span class="n">return_components</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Calculate Perez view factors:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">aoi_projection</span><span class="p">(</span><span class="n">df_inputs</span><span class="o">.</span><span class="n">surface_tilt</span><span class="p">,</span>
                       <span class="n">df_inputs</span><span class="o">.</span><span class="n">surface_azimuth</span><span class="p">,</span> <span class="n">df_inputs</span><span class="o">.</span><span class="n">solar_zenith</span><span class="p">,</span>
                       <span class="n">df_inputs</span><span class="o">.</span><span class="n">solar_azimuth</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">cosd</span><span class="p">(</span><span class="n">df_inputs</span><span class="o">.</span><span class="n">solar_zenith</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">cosd</span><span class="p">(</span><span class="mi">85</span><span class="p">))</span>

    <span class="n">vf_perez</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;vf_horizon&#39;</span><span class="p">:</span> <span class="n">sind</span><span class="p">(</span><span class="n">df_inputs</span><span class="o">.</span><span class="n">surface_tilt</span><span class="p">),</span>
        <span class="s1">&#39;vf_circumsolar&#39;</span><span class="p">:</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span><span class="p">,</span>
        <span class="s1">&#39;vf_isotropic&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">cosd</span><span class="p">(</span><span class="n">df_inputs</span><span class="o">.</span><span class="n">surface_tilt</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="p">},</span>
        <span class="n">index</span><span class="o">=</span><span class="n">df_inputs</span><span class="o">.</span><span class="n">index</span>
    <span class="p">)</span>

    <span class="c1"># Calculate diffuse luminance</span>
    <span class="n">luminance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">components</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">vf_perez</span><span class="p">[</span><span class="s1">&#39;vf_horizon&#39;</span><span class="p">],</span>
            <span class="n">components</span><span class="p">[</span><span class="s1">&#39;circumsolar&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">vf_perez</span><span class="p">[</span><span class="s1">&#39;vf_circumsolar&#39;</span><span class="p">],</span>
            <span class="n">components</span><span class="p">[</span><span class="s1">&#39;isotropic&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">vf_perez</span><span class="p">[</span><span class="s1">&#39;vf_isotropic&#39;</span><span class="p">]</span>
        <span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="n">df_inputs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;luminance_horizon&#39;</span><span class="p">,</span> <span class="s1">&#39;luminance_circumsolar&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;luminance_isotropic&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">luminance</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">components</span><span class="p">[</span><span class="s1">&#39;sky_diffuse&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># Format components column names</span>
    <span class="n">components</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;isotropic&#39;</span><span class="p">:</span> <span class="s1">&#39;poa_isotropic&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;circumsolar&#39;</span><span class="p">:</span> <span class="s1">&#39;poa_circumsolar&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;horizon&#39;</span><span class="p">:</span> <span class="s1">&#39;poa_horizon&#39;</span><span class="p">})</span>

    <span class="n">df_inputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_inputs</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">vf_perez</span><span class="p">,</span> <span class="n">luminance</span><span class="p">],</span>
                          <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
    <span class="n">df_inputs</span> <span class="o">=</span> <span class="n">df_inputs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sky_diffuse&#39;</span><span class="p">:</span> <span class="s1">&#39;poa_total_diffuse&#39;</span><span class="p">})</span>

    <span class="c1"># Adjust the circumsolar luminance when it hits the back surface</span>
    <span class="k">if</span> <span class="n">df_inputs_back_surface</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">df_inputs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sun_hitting_back_surface</span><span class="p">,</span> <span class="s1">&#39;luminance_circumsolar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_inputs_back_surface</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;luminance_circumsolar&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df_inputs</span></div>


<div class="viewcode-block" id="calculate_custom_perez_transposition"><a class="viewcode-back" href="../../developer/generated/pvfactors.timeseries.calculate_custom_perez_transposition.html#pvfactors.timeseries.calculate_custom_perez_transposition">[docs]</a><span class="k">def</span> <span class="nf">calculate_custom_perez_transposition</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">surface_tilt</span><span class="p">,</span>
                                         <span class="n">surface_azimuth</span><span class="p">,</span> <span class="n">solar_zenith</span><span class="p">,</span>
                                         <span class="n">solar_azimuth</span><span class="p">,</span> <span class="n">dni</span><span class="p">,</span> <span class="n">dhi</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate custom perez transposition: some customization is necessary in</span>
<span class="sd">    order to get the circumsolar component when the sun is hitting the back</span>
<span class="sd">    surface as well.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    timestamps : array-like</span>
<span class="sd">        simulation timestamps</span>
<span class="sd">    surface_tilt : array-like</span>
<span class="sd">        Surface tilt angles in decimal degrees.</span>
<span class="sd">        surface_tilt must be &gt;=0 and &lt;=180.</span>
<span class="sd">        The tilt angle is defined as degrees from horizontal</span>
<span class="sd">        (e.g. surface facing up = 0, surface facing horizon = 90)</span>
<span class="sd">    surface_azimuth : array-like</span>
<span class="sd">        The azimuth of the rotated panel,</span>
<span class="sd">        determined by projecting the vector normal to the panel&#39;s surface to</span>
<span class="sd">        the earth&#39;s surface [degrees].</span>
<span class="sd">    solar_zenith : array-like</span>
<span class="sd">        solar zenith angles</span>
<span class="sd">    solar_azimuth : array-like</span>
<span class="sd">        solar azimuth angles</span>
<span class="sd">    dni : array-like</span>
<span class="sd">        values for direct normal irradiance</span>
<span class="sd">    dhi : array-like</span>
<span class="sd">        values for diffuse horizontal irradiance</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df_custom_perez :`pandas.DataFrame`</span>
<span class="sd">        Dataframe with the following columns:</span>
<span class="sd">        [&#39;solar_zenith&#39;, &#39;solar_azimuth&#39;, &#39;surface_tilt&#39;, &#39;surface_azimuth&#39;,</span>
<span class="sd">        &#39;dhi&#39;, &#39;dni&#39;, &#39;vf_horizon&#39;, &#39;vf_circumsolar&#39;, &#39;vf_isotropic&#39;,</span>
<span class="sd">        &#39;luminance_horizon&#39;, &#39;luminance_circumsolar&#39;, &#39;luminance_isotropic&#39;,</span>
<span class="sd">        &#39;poa_isotropic&#39;, &#39;poa_circumsolar&#39;, &#39;poa_horizon&#39;, &#39;poa_total_diffuse&#39;]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate the perez inputs</span>
    <span class="n">df_custom_perez</span> <span class="o">=</span> <span class="n">perez_diffuse_luminance</span><span class="p">(</span>
        <span class="n">timestamps</span><span class="p">,</span> <span class="n">surface_tilt</span><span class="p">,</span> <span class="n">surface_azimuth</span><span class="p">,</span>
        <span class="n">solar_zenith</span><span class="p">,</span> <span class="n">solar_azimuth</span><span class="p">,</span> <span class="n">dni</span><span class="p">,</span> <span class="n">dhi</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_custom_perez</span></div>


<div class="viewcode-block" id="calculate_radiosities_serially_perez"><a class="viewcode-back" href="../../developer/generated/pvfactors.timeseries.calculate_radiosities_serially_perez.html#pvfactors.timeseries.calculate_radiosities_serially_perez">[docs]</a><span class="k">def</span> <span class="nf">calculate_radiosities_serially_perez</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate timeseries results of simulation: run both custom Perez</span>
<span class="sd">    diffuse light transposition calculations and</span>
<span class="sd">    :py:class:`~pvfactors.pvarray.Array` timeseries calculation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : tuple</span>
<span class="sd">        tuple of arguments used to run the timeseries calculation.</span>
<span class="sd">        List in order: ``pvarray_parameters``, ``timestamps``,</span>
<span class="sd">        ``solar_zenith``, ``solar_azimuth``, ``surface_tilt``,</span>
<span class="sd">        ``surface_azimuth``, ``dni``, ``dhi``.</span>
<span class="sd">        All 1-dimensional arrays.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df_registries : ``pandas.DataFrame``</span>
<span class="sd">        Timeseries concatenated form of the</span>
<span class="sd">        :py:class:`~pvfactors.pvarray.Array` surface registry</span>
<span class="sd">    df_custom_perez : ``pandas.DataFrame``</span>
<span class="sd">        Dataframe with custom Perez inputs used in the models</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get arguments</span>
    <span class="p">(</span><span class="n">pvarray_parameters</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">solar_zenith</span><span class="p">,</span> <span class="n">solar_azimuth</span><span class="p">,</span>
     <span class="n">surface_tilt</span><span class="p">,</span> <span class="n">surface_azimuth</span><span class="p">,</span> <span class="n">dni</span><span class="p">,</span> <span class="n">dhi</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span>

    <span class="c1"># Run custom perez transposition: in order to get circumsolar on back</span>
    <span class="c1"># surface too</span>
    <span class="n">df_custom_perez</span> <span class="o">=</span> <span class="n">calculate_custom_perez_transposition</span><span class="p">(</span>
        <span class="n">timestamps</span><span class="p">,</span> <span class="n">surface_tilt</span><span class="p">,</span> <span class="n">surface_azimuth</span><span class="p">,</span> <span class="n">solar_zenith</span><span class="p">,</span>
        <span class="n">solar_azimuth</span><span class="p">,</span> <span class="n">dni</span><span class="p">,</span> <span class="n">dhi</span><span class="p">)</span>

    <span class="c1"># Get the necessary inputs</span>
    <span class="n">luminance_isotropic</span> <span class="o">=</span> <span class="n">df_custom_perez</span><span class="o">.</span><span class="n">luminance_isotropic</span><span class="o">.</span><span class="n">values</span>
    <span class="n">luminance_circumsolar</span> <span class="o">=</span> <span class="n">df_custom_perez</span><span class="o">.</span><span class="n">luminance_circumsolar</span><span class="o">.</span><span class="n">values</span>
    <span class="n">poa_horizon</span> <span class="o">=</span> <span class="n">df_custom_perez</span><span class="o">.</span><span class="n">poa_horizon</span><span class="o">.</span><span class="n">values</span>
    <span class="n">poa_circumsolar</span> <span class="o">=</span> <span class="n">df_custom_perez</span><span class="o">.</span><span class="n">poa_circumsolar</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Run timeseries calculation</span>
    <span class="n">df_registries</span> <span class="o">=</span> <span class="n">array_timeseries_calculate</span><span class="p">(</span>
        <span class="n">pvarray_parameters</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">solar_zenith</span><span class="p">,</span> <span class="n">solar_azimuth</span><span class="p">,</span>
        <span class="n">surface_tilt</span><span class="p">,</span> <span class="n">surface_azimuth</span><span class="p">,</span> <span class="n">dni</span><span class="p">,</span> <span class="n">luminance_isotropic</span><span class="p">,</span>
        <span class="n">luminance_circumsolar</span><span class="p">,</span> <span class="n">poa_horizon</span><span class="p">,</span> <span class="n">poa_circumsolar</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_registries</span><span class="p">,</span> <span class="n">df_custom_perez</span></div>


<div class="viewcode-block" id="calculate_radiosities_parallel_perez"><a class="viewcode-back" href="../../developer/generated/pvfactors.timeseries.calculate_radiosities_parallel_perez.html#pvfactors.timeseries.calculate_radiosities_parallel_perez">[docs]</a><span class="k">def</span> <span class="nf">calculate_radiosities_parallel_perez</span><span class="p">(</span>
        <span class="n">pvarray_parameters</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">solar_zenith</span><span class="p">,</span> <span class="n">solar_azimuth</span><span class="p">,</span>
        <span class="n">surface_tilt</span><span class="p">,</span> <span class="n">surface_azimuth</span><span class="p">,</span> <span class="n">dni</span><span class="p">,</span> <span class="n">dhi</span><span class="p">,</span> <span class="n">n_processes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate timeseries results of simulation in parallel:</span>
<span class="sd">    run both custom Perez diffuse light transposition calculations and</span>
<span class="sd">    :py:class:`~pvfactors.pvarray.Array` timeseries calculation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pvarray_parameters : dict</span>
<span class="sd">        parameters used to instantiate :py:class:`~pvfactors.pvarray.Array`</span>
<span class="sd">    timestamps : array-like</span>
<span class="sd">        simulation timestamps</span>
<span class="sd">    solar_zenith : array-like</span>
<span class="sd">        solar zenith angles</span>
<span class="sd">    solar_azimuth : array-like</span>
<span class="sd">        solar azimuth angles</span>
<span class="sd">    surface_tilt : array-like</span>
<span class="sd">        Surface tilt angles in decimal degrees.</span>
<span class="sd">        surface_tilt must be &gt;=0 and &lt;=180.</span>
<span class="sd">        The tilt angle is defined as degrees from horizontal</span>
<span class="sd">        (e.g. surface facing up = 0, surface facing horizon = 90)</span>
<span class="sd">    surface_azimuth : array-like</span>
<span class="sd">        The azimuth of the rotated panel,</span>
<span class="sd">        determined by projecting the vector normal to the panel&#39;s surface to</span>
<span class="sd">        the earth&#39;s surface [degrees].</span>
<span class="sd">    dni : array-like</span>
<span class="sd">        values for direct normal irradiance</span>
<span class="sd">    dhi : array-like</span>
<span class="sd">        values for diffuse horizontal irradiance</span>
<span class="sd">    n_processes : int, optional</span>
<span class="sd">        (default ``None`` = use all available CPUs) number of</span>
<span class="sd">        CPUs to use. Default value will be the total number of processors</span>
<span class="sd">        on the machine.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df_registries : ``pandas.DataFrame``</span>
<span class="sd">        Timeseries concatenated form of the</span>
<span class="sd">        :py:class:`~pvfactors.pvarray.Array` surface registry</span>
<span class="sd">    df_custom_perez : ``pandas.DataFrame``</span>
<span class="sd">        Dataframe with custom Perez inputs used in the models</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Choose number of workers</span>
    <span class="k">if</span> <span class="n">n_processes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_processes</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span>

    <span class="c1"># Split all arguments according to number of processes</span>
    <span class="p">(</span><span class="n">list_timestamps</span><span class="p">,</span> <span class="n">list_surface_azimuth</span><span class="p">,</span> <span class="n">list_surface_tilt</span><span class="p">,</span>
     <span class="n">list_solar_zenith</span><span class="p">,</span> <span class="n">list_solar_azimuth</span><span class="p">,</span> <span class="n">list_dni</span><span class="p">,</span> <span class="n">list_dhi</span><span class="p">)</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span>
         <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">,</span>
         <span class="p">[</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">surface_azimuth</span><span class="p">,</span> <span class="n">surface_tilt</span><span class="p">,</span>
          <span class="n">solar_zenith</span><span class="p">,</span> <span class="n">solar_azimuth</span><span class="p">,</span> <span class="n">dni</span><span class="p">,</span> <span class="n">dhi</span><span class="p">],</span>
        <span class="p">[</span><span class="n">n_processes</span><span class="p">]</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">list_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">pvarray_parameters</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_processes</span>
    <span class="c1"># Zip all the arguments together</span>
    <span class="n">list_args</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">list_parameters</span><span class="p">,</span> <span class="n">list_timestamps</span><span class="p">,</span> <span class="n">list_solar_zenith</span><span class="p">,</span>
                      <span class="n">list_solar_azimuth</span><span class="p">,</span> <span class="n">list_surface_tilt</span><span class="p">,</span>
                      <span class="n">list_surface_azimuth</span><span class="p">,</span> <span class="n">list_dni</span><span class="p">,</span> <span class="n">list_dhi</span><span class="p">))</span>

    <span class="c1"># Start multiprocessing</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">n_processes</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">calculate_radiosities_serially_perez</span><span class="p">,</span> <span class="n">list_args</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Parallel calculation elapsed time: </span><span class="si">%s</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

    <span class="n">results_grouped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)</span>
    <span class="n">results_concat</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span>
                                             <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                         <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">results_grouped</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results_concat</span></div>


<div class="viewcode-block" id="get_average_pvrow_outputs"><a class="viewcode-back" href="../../developer/generated/pvfactors.timeseries.get_average_pvrow_outputs.html#pvfactors.timeseries.get_average_pvrow_outputs">[docs]</a><span class="k">def</span> <span class="nf">get_average_pvrow_outputs</span><span class="p">(</span><span class="n">df_registries</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">COLS_TO_SAVE</span><span class="p">,</span>
                              <span class="n">include_shading</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;For each pvrow surface (front and back), calculate the weighted</span>
<span class="sd">    average irradiance and shading values (weighted by length of surface).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_registries : ``pandas.DataFrame``</span>
<span class="sd">        timestamped and concatenated :py:class:`~pvfactors.pvarray.Array`</span>
<span class="sd">        surface registries</span>
<span class="sd">    values : list, optional</span>
<span class="sd">        list of column names from the surface registries to</span>
<span class="sd">        keep (default=``COLS_TO_SAVE``)</span>
<span class="sd">    include_shading : bool, optional</span>
<span class="sd">        flag to decide whether to keep column</span>
<span class="sd">        indicating if surface has direct shading or not</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ``pandas.DataFrame``</span>
<span class="sd">        dataframe with averaged values and flags</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">weight_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span>
    <span class="n">shade_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;shaded&#39;</span><span class="p">]</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">,</span> <span class="s1">&#39;pvrow_index&#39;</span><span class="p">,</span> <span class="s1">&#39;surface_side&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">include_shading</span><span class="p">:</span>
        <span class="n">final_cols</span> <span class="o">=</span> <span class="n">values</span> <span class="o">+</span> <span class="n">shade_col</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_cols</span> <span class="o">=</span> <span class="n">values</span>

    <span class="c1"># Format registry to get averaged outputs for each surface type</span>
    <span class="n">df_outputs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">deepcopy</span><span class="p">(</span><span class="n">df_registries</span><span class="p">)</span>
        <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;line_type == &quot;pvrow&quot;&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pvrow_index</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;pvrow_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">values</span> <span class="o">+</span> <span class="n">indexes</span> <span class="o">+</span> <span class="n">weight_col</span> <span class="o">+</span> <span class="n">shade_col</span><span class="p">]</span>
        <span class="c1"># Weighted averages: make sure to close the col value in lambdas</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">col</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">weight_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                   <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">values</span><span class="p">})</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">shaded</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shaded</span><span class="p">))</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span>
        <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">col</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="n">weight_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                   <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">values</span><span class="p">})</span>
        <span class="c1"># summed up bool values, so there is shading if the shaded col &gt; 0</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">shade_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">shade_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">})</span>
        <span class="c1"># Now pivot data to the right format</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="n">indexes</span><span class="p">,</span> <span class="n">value_vars</span><span class="o">=</span><span class="n">final_cols</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;term&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">],</span>
                     <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pvrow_index&#39;</span><span class="p">,</span> <span class="s1">&#39;surface_side&#39;</span><span class="p">,</span> <span class="s1">&#39;term&#39;</span><span class="p">],</span>
                     <span class="n">values</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span>
                     <span class="c1"># The following works because there is no actual</span>
                     <span class="c1"># aggregation happening</span>
                     <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;first&#39;</span>  <span class="c1"># necessary to keep &#39;shaded&#39; bool values</span>
                     <span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">add_df_registries_nans</span><span class="p">,</span> <span class="n">df_registries</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Make sure numerical types are as expected</span>
    <span class="n">df_outputs</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">values</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_outputs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">values</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_outputs</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_pvrow_segment_outputs"><a class="viewcode-back" href="../../developer/generated/pvfactors.timeseries.get_pvrow_segment_outputs.html#pvfactors.timeseries.get_pvrow_segment_outputs">[docs]</a><span class="k">def</span> <span class="nf">get_pvrow_segment_outputs</span><span class="p">(</span><span class="n">df_registries</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">COLS_TO_SAVE</span><span class="p">,</span>
                              <span class="n">include_shading</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;For each discretized segment of a pvrow surface (front and back),</span>
<span class="sd">    calculate the weighted average irradiance and shading values</span>
<span class="sd">    (weighted by length of surface).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_registries : ``pandas.DataFrame``</span>
<span class="sd">        timestamped and concatenated :py:class:`~pvfactors.pvarray.Array`</span>
<span class="sd">        surface registries</span>
<span class="sd">    values : list, optional</span>
<span class="sd">        list of column names from the surface registries to</span>
<span class="sd">        keep (default=``COLS_TO_SAVE``)</span>
<span class="sd">    include_shading : bool, optional</span>
<span class="sd">        flag to decide whether to keep column</span>
<span class="sd">        indicating if surface has direct shading or not</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ``pandas.DataFrame``</span>
<span class="sd">        dataframe with averaged values and flags</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">weight_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span>
    <span class="n">shade_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;shaded&#39;</span><span class="p">]</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">,</span> <span class="s1">&#39;pvrow_index&#39;</span><span class="p">,</span> <span class="s1">&#39;surface_side&#39;</span><span class="p">,</span>
               <span class="s1">&#39;pvrow_segment_index&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">include_shading</span><span class="p">:</span>
        <span class="n">final_cols</span> <span class="o">=</span> <span class="n">values</span> <span class="o">+</span> <span class="n">shade_col</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_cols</span> <span class="o">=</span> <span class="n">values</span>

    <span class="c1"># Format registry to get averaged outputs for each surface type</span>
    <span class="n">df_segments</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">deepcopy</span><span class="p">(</span><span class="n">df_registries</span><span class="p">)</span>
        <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df_registries</span><span class="o">.</span><span class="n">pvrow_segment_index</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
             <span class="n">values</span> <span class="o">+</span> <span class="n">indexes</span> <span class="o">+</span> <span class="n">weight_col</span> <span class="o">+</span> <span class="n">shade_col</span><span class="p">]</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">pvrow_segment_index</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;pvrow_segment_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="n">pvrow_index</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;pvrow_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="n">shaded</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shaded</span><span class="p">))</span>
        <span class="c1"># Weighted averages: make sure to close the col value in lambdas</span>
        <span class="c1"># Include shaded and non shaded segments</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">col</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">weight_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                   <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">values</span><span class="p">})</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span>
        <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">col</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="n">weight_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                   <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">values</span><span class="p">})</span>
        <span class="c1"># summed up bool values, so there is shading if the shaded col &gt; 0</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">shade_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">shade_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">})</span>
        <span class="c1"># Now pivot data to the right format</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="n">indexes</span><span class="p">,</span> <span class="n">value_vars</span><span class="o">=</span><span class="n">final_cols</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;term&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">],</span>
                     <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pvrow_index&#39;</span><span class="p">,</span> <span class="s1">&#39;surface_side&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;pvrow_segment_index&#39;</span><span class="p">,</span> <span class="s1">&#39;term&#39;</span><span class="p">],</span>
                     <span class="n">values</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span>
                     <span class="c1"># The following works because there is no actual</span>
                     <span class="c1"># aggregation happening</span>
                     <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;first&#39;</span>  <span class="c1"># necessary to keep &#39;shaded&#39; bool values</span>
                     <span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">add_df_registries_nans</span><span class="p">,</span> <span class="n">df_registries</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># Make sure numerical types are as expected</span>
    <span class="n">df_segments</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">values</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_segments</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">values</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_segments</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span></div>


<div class="viewcode-block" id="breakup_df_inputs"><a class="viewcode-back" href="../../developer/generated/pvfactors.timeseries.breakup_df_inputs.html#pvfactors.timeseries.breakup_df_inputs">[docs]</a><span class="k">def</span> <span class="nf">breakup_df_inputs</span><span class="p">(</span><span class="n">df_inputs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function: It is sometimes easier to provide a dataframe than a list</span>
<span class="sd">    of arrays: this function does the job of breaking up the dataframe into a</span>
<span class="sd">    list of expected 1-dim arrays</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_inputs : ``pandas.DataFrame``</span>
<span class="sd">        timestamp-indexed dataframe with following columns:</span>
<span class="sd">        &#39;surface_azimuth&#39;, &#39;surface_tilt&#39;, &#39;solar_zenith&#39;, &#39;solar_azimuth&#39;,</span>
<span class="sd">        &#39;dni&#39;, &#39;dhi&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    all 1-dim ``numpy.ndarray``</span>
<span class="sd">        ``timestamps``, ``tilt_angles``, ``surface_azimuth``,</span>
<span class="sd">        ``solar_zenith``, ``solar_azimuth``, ``dni``, ``dhi``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_inputs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">surface_azimuth</span> <span class="o">=</span> <span class="n">df_inputs</span><span class="o">.</span><span class="n">surface_azimuth</span><span class="o">.</span><span class="n">values</span>
    <span class="n">surface_tilt</span> <span class="o">=</span> <span class="n">df_inputs</span><span class="o">.</span><span class="n">surface_tilt</span><span class="o">.</span><span class="n">values</span>
    <span class="n">solar_zenith</span> <span class="o">=</span> <span class="n">df_inputs</span><span class="o">.</span><span class="n">solar_zenith</span><span class="o">.</span><span class="n">values</span>
    <span class="n">solar_azimuth</span> <span class="o">=</span> <span class="n">df_inputs</span><span class="o">.</span><span class="n">solar_azimuth</span><span class="o">.</span><span class="n">values</span>
    <span class="n">dni</span> <span class="o">=</span> <span class="n">df_inputs</span><span class="o">.</span><span class="n">dni</span><span class="o">.</span><span class="n">values</span>
    <span class="n">dhi</span> <span class="o">=</span> <span class="n">df_inputs</span><span class="o">.</span><span class="n">dhi</span><span class="o">.</span><span class="n">values</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">surface_tilt</span><span class="p">,</span> <span class="n">surface_azimuth</span><span class="p">,</span>
            <span class="n">solar_zenith</span><span class="p">,</span> <span class="n">solar_azimuth</span><span class="p">,</span> <span class="n">dni</span><span class="p">,</span> <span class="n">dhi</span><span class="p">)</span></div>


<div class="viewcode-block" id="add_df_registries_nans"><a class="viewcode-back" href="../../developer/generated/pvfactors.timeseries.add_df_registries_nans.html#pvfactors.timeseries.add_df_registries_nans">[docs]</a><span class="k">def</span> <span class="nf">add_df_registries_nans</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">df_registries</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;df_registries has nan entries for timestamps that were skipped,</span>
<span class="sd">    make sure to add them back in with this function</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : ``pandas.DataFrame``</span>
<span class="sd">        dataframe to which the nan values will be added</span>
<span class="sd">    df_registries : ``pandas.DataFrame``</span>
<span class="sd">        dataframe of concatenated registries, coming</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ``pandas.DataFrame``</span>
<span class="sd">        Result dataframe with nan values added</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_registries</span> <span class="o">=</span> <span class="n">df_registries</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamps&#39;</span><span class="p">)</span>
    <span class="n">list_idx_nans</span> <span class="o">=</span> <span class="n">df_registries</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
        <span class="n">df_registries</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">list_idx_nans</span><span class="p">:</span>
        <span class="n">df_nan</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                              <span class="n">index</span><span class="o">=</span><span class="n">list_idx_nans</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_nan</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Copyright 2016, SunPower Corporation

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>